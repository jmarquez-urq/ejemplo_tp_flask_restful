<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>Enlaces</title>
        <link rel="stylesheet" href="/static/css/estilo.css">
    </head>
    <body>
        <h1>Enlaces guardados</h1>
        <div id="nuevo"><a href="/guardar_enlace">Crear nuevo enlace</a></div>
        <div id="resultado"></div>
        <div id="enlaces"></div>
<script>
function cargar_enlaces() {
    // Recuperar el token JWT
    const token = localStorage.getItem('access_token');
    if (!token) {
        alert("Esta página es solamente para usuarios");
        window.location.href = "/";
        return;
    }

    // Hacemos fetch por GET enviando el token JWT:
    fetch('/links', {
        headers: {
            'Content-Type' : 'application/json',
            'Authorization': `Bearer ${token}`
        }
    })
    .then (respuesta => respuesta.json())
    .then (datos => { mostrar_respuesta(datos); })
    .catch( e => { console.log(e); });
}

function mostrar_respuesta(datos) {
    // Si no hay enlaces, lo indicamos:
    if (datos.enlaces.length == 0) {
        document.querySelector("#enlaces").innerHTML = "<p>No hay enlaces</p>";
        return;
    }
    // Para cada uno de los enlaces:
    for (let enlace of datos.enlaces) {
        // 1. creamos un h2 para el título, 
        let h2 = document.createElement("h2");
        h2.textContent = enlace.titulo;

        // 2. creamos el enlace propiamente dicho,
        let a = document.createElement("a");
        a.textContent = "Enlace";
        a.href = enlace.url;

        // 3. creamos un párrafo con la descripción, 
        let p = document.createElement("p");
        p.textContent = enlace.descripcion;

        // 4. creamos un div que incluya el h2 (1), el párrafo (2) y el enlace (3)
        let div_enlace = document.createElement("div");
        div_enlace.id = "enlace_" + enlace.id;
        div_enlace.appendChild(h2);
        div_enlace.appendChild(a);
        div_enlace.appendChild(p);

        // 5. Si tiene permiso para borrar, mostramos el botón eliminar:
        if (enlace.borrable) {
            let borrar = document.createElement("button");
            borrar.textContent = "Eliminar";
            borrar.type = "button";
            // Cuando alguien haga clic en el botón, llamamos a la función eliminar_enlace:
            borrar.addEventListener('click', function(event) { eliminar_enlace(enlace.id); });
            // Agregamos también el botón para borrar en el div:
            div_enlace.appendChild(borrar);
        }

        // 6. finalmente, agregamos el div creado (4), dentro del div con id="enlaces" (linea 11)
        document.querySelector("#enlaces").appendChild(div_enlace);
    }
}

function eliminar_enlace(id)
{
    // Recuperar el token JWT
    const token = localStorage.getItem('access_token');
    if (!token) {
        alert("Esta página es solamente para usuarios");
        window.location.href = "/";
        return;
    }

    // Por ejemplo, para borrar el enlace con id 4, la url es /links/4 por DELETE:
    const url = "/links/" + id;
    fetch (url, {
       "method": "DELETE", 
       "headers": {
            'Content-Type' : 'application/json',
            'Authorization': `Bearer ${token}`
        },
    })
    .then(respuesta => {
        // Si fue borrado correctamente, retorna 204
        if (respuesta.status == 204) {
          // Lo borramos de la página, y retornamos el mensaje de respuesta:
          document.querySelector("#enlace_" + id).remove();
          // Mostramos el mensaje de respuesta:
          document.querySelector('#resultado').textContent = "Enlace borrado correctamente";
        } else {
          throw new Error(`${respuesta.status}`);
        }
    })
    .catch( e => {
         document.querySelector('#resultado').textContent = e;
    });
}

// Al terminar de cargar la página, ejecutamos la función cargar_enlaces():
document.addEventListener('DOMContentLoaded', cargar_enlaces);
</script>
    </body>
</html>
